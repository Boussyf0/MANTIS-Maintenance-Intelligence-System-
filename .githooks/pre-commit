#!/bin/bash
# Pre-commit hook pour MANTIS
# VÃ©rifie la qualitÃ© du code avant chaque commit

set -e

echo "ğŸ” MANTIS Pre-commit Hook - Validation en cours..."

# Couleurs pour les messages
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Compteur d'erreurs
ERRORS=0

# 1. VÃ©rifier les fichiers staged
echo -e "\n${YELLOW}[1/6]${NC} VÃ©rification des fichiers staged..."
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${RED}âœ—${NC} Aucun fichier staged"
    exit 1
fi

echo -e "${GREEN}âœ“${NC} Fichiers staged trouvÃ©s"

# 2. VÃ©rifier qu'il n'y a pas de fichiers sensibles
echo -e "\n${YELLOW}[2/6]${NC} VÃ©rification des fichiers sensibles..."
SENSITIVE_PATTERNS=(
    "\.env$"
    "credentials\.json$"
    "\.key$"
    "\.pem$"
    "password"
    "secret"
    "api[_-]?key"
)

for pattern in "${SENSITIVE_PATTERNS[@]}"; do
    if echo "$STAGED_FILES" | grep -iE "$pattern" > /dev/null; then
        echo -e "${RED}âœ—${NC} Fichier sensible dÃ©tectÃ© : correspond Ã  '$pattern'"
        echo -e "${RED}  ATTENTION: Ne commitez jamais de secrets ou credentials!${NC}"
        ERRORS=$((ERRORS + 1))
    fi
done

if [ $ERRORS -eq 0 ]; then
    echo -e "${GREEN}âœ“${NC} Pas de fichiers sensibles dÃ©tectÃ©s"
fi

# 3. VÃ©rifier les fichiers Java
JAVA_FILES=$(echo "$STAGED_FILES" | grep "\.java$" || true)
if [ ! -z "$JAVA_FILES" ]; then
    echo -e "\n${YELLOW}[3/6]${NC} VÃ©rification du code Java..."

    # Trouver les services Java modifiÃ©s
    JAVA_SERVICES=$(echo "$JAVA_FILES" | grep -o "services/[^/]*" | sort -u || true)

    for service in $JAVA_SERVICES; do
        if [ -f "$service/pom.xml" ]; then
            echo "  Compilation et tests pour $service..."
            (cd "$service" && mvn clean test -q) || {
                echo -e "${RED}âœ—${NC} Ã‰chec des tests pour $service"
                ERRORS=$((ERRORS + 1))
            }
        fi
    done

    if [ $ERRORS -eq 0 ]; then
        echo -e "${GREEN}âœ“${NC} Code Java valide"
    fi
else
    echo -e "\n${YELLOW}[3/6]${NC} Aucun fichier Java modifiÃ©"
fi

# 4. VÃ©rifier les fichiers Python
PYTHON_FILES=$(echo "$STAGED_FILES" | grep "\.py$" || true)
if [ ! -z "$PYTHON_FILES" ]; then
    echo -e "\n${YELLOW}[4/6]${NC} VÃ©rification du code Python..."

    # VÃ©rifier si flake8 est installÃ©
    if command -v flake8 &> /dev/null; then
        echo "$PYTHON_FILES" | xargs flake8 --max-line-length=120 || {
            echo -e "${RED}âœ—${NC} Erreurs flake8 dÃ©tectÃ©es"
            ERRORS=$((ERRORS + 1))
        }
    else
        echo -e "${YELLOW}âš ${NC} flake8 non installÃ©, validation Python ignorÃ©e"
    fi

    # VÃ©rifier si black est installÃ©
    if command -v black &> /dev/null; then
        echo "$PYTHON_FILES" | xargs black --check --line-length=120 || {
            echo -e "${RED}âœ—${NC} Code Python non formatÃ© (exÃ©cutez: black .)"
            ERRORS=$((ERRORS + 1))
        }
    fi

    if [ $ERRORS -eq 0 ]; then
        echo -e "${GREEN}âœ“${NC} Code Python valide"
    fi
else
    echo -e "\n${YELLOW}[4/6]${NC} Aucun fichier Python modifiÃ©"
fi

# 5. VÃ©rifier la structure des messages de commit
echo -e "\n${YELLOW}[5/6]${NC} PrÃ©paration du message de commit..."
if [ -f ".git/COMMIT_EDITMSG" ]; then
    COMMIT_MSG=$(cat .git/COMMIT_EDITMSG 2>/dev/null || echo "")
    if [ ! -z "$COMMIT_MSG" ]; then
        # Le message sera vÃ©rifiÃ© par commit-msg hook
        echo -e "${GREEN}âœ“${NC} Message de commit sera vÃ©rifiÃ©"
    fi
fi

# 6. VÃ©rifier les conflits de merge non rÃ©solus
echo -e "\n${YELLOW}[6/6]${NC} VÃ©rification des conflits de merge..."
# Exclure les fichiers oÃ¹ les marqueurs de conflit sont intentionnels (hooks, docs)
CONFLICT_FILES=$(echo "$STAGED_FILES" | grep -v "\.githooks/" | grep -v "README_VALIDATION\.md" | xargs grep -l "<<<<<<< HEAD" 2>/dev/null || true)
if [ -n "$CONFLICT_FILES" ]; then
    echo -e "${RED}âœ—${NC} Conflits de merge non rÃ©solus dÃ©tectÃ©s!"
    echo "$CONFLICT_FILES"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}âœ“${NC} Pas de conflits de merge"
fi

# RÃ©sumÃ©
echo -e "\n${YELLOW}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
if [ $ERRORS -eq 0 ]; then
    echo -e "${GREEN}âœ“ Toutes les vÃ©rifications sont passÃ©es!${NC}"
    echo -e "${YELLOW}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
    exit 0
else
    echo -e "${RED}âœ— $ERRORS erreur(s) dÃ©tectÃ©e(s)${NC}"
    echo -e "${YELLOW}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
    echo -e "${RED}Commit annulÃ©. Corrigez les erreurs et rÃ©essayez.${NC}\n"
    exit 1
fi
