#!/bin/bash
# Commit-msg hook pour MANTIS
# VÃ©rifie la structure du message de commit

set -e

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "\n${YELLOW}ğŸ” Validation du message de commit...${NC}\n"

# Ignorer les commits de merge
if grep -q "^Merge" "$COMMIT_MSG_FILE"; then
    echo -e "${GREEN}âœ“${NC} Message de merge dÃ©tectÃ©, validation ignorÃ©e"
    exit 0
fi

# RÃ¨gles de validation
ERRORS=0

# 1. VÃ©rifier la longueur du titre (premiÃ¨re ligne)
TITLE=$(echo "$COMMIT_MSG" | head -n1)
TITLE_LENGTH=${#TITLE}

echo -e "${YELLOW}[1/5]${NC} VÃ©rification de la longueur du titre..."
if [ $TITLE_LENGTH -lt 10 ]; then
    echo -e "${RED}âœ—${NC} Titre trop court ($TITLE_LENGTH caractÃ¨res, minimum 10)"
    ERRORS=$((ERRORS + 1))
elif [ $TITLE_LENGTH -gt 72 ]; then
    echo -e "${RED}âœ—${NC} Titre trop long ($TITLE_LENGTH caractÃ¨res, maximum 72)"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}âœ“${NC} Longueur du titre OK ($TITLE_LENGTH caractÃ¨res)"
fi

# 2. VÃ©rifier le format du titre (Convention Conventional Commits)
echo -e "\n${YELLOW}[2/5]${NC} VÃ©rification du format Conventional Commits..."
VALID_TYPES="feat|fix|docs|style|refactor|perf|test|build|ci|chore"

if echo "$TITLE" | grep -qE "^($VALID_TYPES)(\(.+\))?: .+"; then
    echo -e "${GREEN}âœ“${NC} Format valide"
    TYPE=$(echo "$TITLE" | sed -E 's/^([a-z]+).*/\1/')
    echo -e "  Type: ${GREEN}$TYPE${NC}"
else
    echo -e "${RED}âœ—${NC} Format invalide"
    echo -e "${YELLOW}Format attendu:${NC} <type>(<scope>): <description>"
    echo -e "${YELLOW}Types valides:${NC} $VALID_TYPES"
    echo -e "${YELLOW}Exemple:${NC} feat(ingestion): ajouter support pour Modbus TCP"
    ERRORS=$((ERRORS + 1))
fi

# 3. VÃ©rifier qu'il y a une ligne vide aprÃ¨s le titre
echo -e "\n${YELLOW}[3/5]${NC} VÃ©rification de la ligne vide aprÃ¨s le titre..."
if [ $(echo "$COMMIT_MSG" | wc -l) -gt 1 ]; then
    SECOND_LINE=$(echo "$COMMIT_MSG" | sed -n '2p')
    if [ ! -z "$SECOND_LINE" ]; then
        echo -e "${RED}âœ—${NC} La deuxiÃ¨me ligne doit Ãªtre vide"
        ERRORS=$((ERRORS + 1))
    else
        echo -e "${GREEN}âœ“${NC} Ligne vide prÃ©sente"
    fi
else
    echo -e "${YELLOW}âš ${NC} Pas de corps de message (optionnel)"
fi

# 4. VÃ©rifier la capitalisation
echo -e "\n${YELLOW}[4/5]${NC} VÃ©rification de la capitalisation..."
DESCRIPTION=$(echo "$TITLE" | sed -E 's/^[a-z]+(\(.+\))?: //')
FIRST_CHAR=$(echo "$DESCRIPTION" | cut -c1)

if echo "$FIRST_CHAR" | grep -q "[a-z]"; then
    echo -e "${GREEN}âœ“${NC} Description commence par une minuscule"
elif echo "$FIRST_CHAR" | grep -q "[A-Z]"; then
    echo -e "${YELLOW}âš ${NC} Description commence par une majuscule (minuscule recommandÃ©e)"
else
    echo -e "${GREEN}âœ“${NC} OK"
fi

# 5. VÃ©rifier qu'il n'y a pas de point Ã  la fin
echo -e "\n${YELLOW}[5/5]${NC} VÃ©rification du point final..."
if echo "$TITLE" | grep -q "\.$"; then
    echo -e "${RED}âœ—${NC} Le titre ne doit pas se terminer par un point"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}âœ“${NC} Pas de point final"
fi

# Afficher le message de commit
echo -e "\n${YELLOW}Message de commit:${NC}"
echo -e "${YELLOW}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
echo "$COMMIT_MSG"
echo -e "${YELLOW}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}\n"

# RÃ©sultat final
if [ $ERRORS -eq 0 ]; then
    echo -e "${GREEN}âœ“ Message de commit valide!${NC}\n"
    exit 0
else
    echo -e "${RED}âœ— $ERRORS erreur(s) dans le message de commit${NC}"
    echo -e "${RED}Commit annulÃ©. Corrigez le message et rÃ©essayez.${NC}\n"
    echo -e "${YELLOW}Documentation:${NC} https://www.conventionalcommits.org/"
    exit 1
fi
