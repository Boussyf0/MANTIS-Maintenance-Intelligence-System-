# MANTIS Prometheus Recording Rules
# Pre-computed aggregations for faster queries

groups:
  - name: mantis_infrastructure
    interval: 30s
    rules:
      # Database connection pool usage
      - record: mantis:postgres:connection_pool_usage:ratio
        expr: |
          sum(pg_stat_database_numbackends) by (instance) / on (instance) max(pg_settings_max_connections) by (instance)

      # Redis memory usage percentage
      - record: mantis:redis:memory_usage:ratio
        expr: |
          redis_memory_used_bytes / redis_memory_max_bytes

      # Container CPU usage (per service)
      - record: mantis:container:cpu_usage:rate5m
        expr: |
          rate(container_cpu_usage_seconds_total{container_label_com_docker_compose_project=~"mantis|docker"}[5m])

      # Container memory usage (per service)
      - record: mantis:container:memory_usage:bytes
        expr: |
          container_memory_usage_bytes{container_label_com_docker_compose_project=~"mantis|docker"}

  - name: mantis_application
    interval: 15s
    rules:
      # HTTP request rate (per service)
      - record: mantis:http:requests:rate1m
        expr: |
          rate(http_server_requests_seconds_count{job=~"ingestion-iiot|preprocessing|orchestrator|dashboard-api"}[1m])

      # HTTP error rate (4xx + 5xx)
      - record: mantis:http:errors:rate1m
        expr: |
          rate(http_server_requests_seconds_count{status=~"4..|5..", job=~"ingestion-iiot|preprocessing|orchestrator|dashboard-api"}[1m])

      # Kafka message processing rate
      - record: mantis:kafka:messages:rate1m
        expr: |
          rate(spring_kafka_listener_seconds_count[1m]) or rate(feature_extraction_messages_processed_total[1m]) or rate(anomaly_detection_messages_processed_total[1m]) or rate(rul_prediction_messages_processed_total[1m]) or rate(kafka_producer_record_send_total{job="ingestion-iiot"}[1m])

      # Data processing latency (p95)
      - record: mantis:processing:latency:p95
        expr: |
          histogram_quantile(0.95, rate(feature_extraction_processing_seconds_bucket[5m])) or histogram_quantile(0.95, rate(anomaly_detection_processing_seconds_bucket[5m])) or histogram_quantile(0.95, rate(rul_prediction_processing_seconds_bucket[5m]))

      # Data Ingestion Rate (derived from producer metrics)
      - record: sensor_data_ingested_total
        expr: |
          sum(rate(kafka_topic_partition_current_offset{topic="raw-sensor-data"}[1m]))

  - name: mantis_ml_metrics
    interval: 60s
    rules:
      # Model inference rate
      - record: mantis:ml:inference:rate5m
        expr: |
          rate(rul_prediction_predictions_made_total[5m])

      # Model inference latency (p99)
      - record: mantis:ml:inference_latency:p99
        expr: |
          histogram_quantile(0.99, rate(rul_prediction_processing_seconds_bucket[5m]))

      # Anomaly detection rate
      - record: mantis:ml:anomalies_detected:rate1h
        expr: |
          rate(anomalies_detected_total[1h])

      # RUL prediction accuracy (when available)
      - record: mantis:ml:rul_mae:avg5m
        expr: |
          avg_over_time(rul_prediction_mae[5m])
