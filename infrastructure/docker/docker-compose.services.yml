version: '3.8'

# Docker Compose file for MANTIS microservices
# All application services that depend on the infrastructure
# defined in docker-compose.infrastructure.yml

networks:
  mantis-network:
    external: true
    name: docker_mantis-network

services:
  # ================================================================
  # SERVICE 1: Ingestion IIoT Service (Java/Spring Boot)
  # ================================================================
  ingestion-iiot:
    build:
      context: ../../services/ingestion-iiot
      dockerfile: Dockerfile
    image: mantis/ingestion-iiot:1.0.0
    container_name: mantis-ingestion-iiot
    hostname: ingestion-iiot
    restart: unless-stopped
    ports:
      - "8001:8001"
    environment:
      SERVER_PORT: 8001
      ENVIRONMENT: ${ENVIRONMENT:-development}
      KAFKA_BOOTSTRAP_SERVERS: mantis-kafka:9092
      SPRING_KAFKA_BOOTSTRAP_SERVERS: mantis-kafka:9092
      POSTGRES_HOST: mantis-postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: mantis
      POSTGRES_USER: ${POSTGRES_USER:-mantis}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-mantis_password}
      JAVA_OPTS: >-
        -Xmx512m -Xms256m -XX:+UseG1GC -Duser.timezone=UTC
    networks:
      - mantis-network
    depends_on:
      kafka-wait:
        condition: service_completed_successfully

  # ================================================================
  # SERVICE 2: Preprocessing Service (Java/Spring Boot)
  # ================================================================
  preprocessing:
    build:
      context: ../../services/preprocessing
      dockerfile: Dockerfile
    image: mantis/preprocessing:1.0.0
    container_name: mantis-preprocessing
    hostname: preprocessing
    restart: unless-stopped
    ports:
      - "8002:8080"
    environment:
      SERVER_PORT: 8080
      SPRING_KAFKA_BOOTSTRAP_SERVERS: mantis-kafka:9092
      SPRING_DATASOURCE_URL: jdbc:postgresql://mantis-postgres:5432/mantis
      SPRING_DATASOURCE_USERNAME: mantis
      SPRING_DATASOURCE_PASSWORD: mantis_password
    networks:
      - mantis-network
    depends_on:
      kafka-wait:
        condition: service_completed_successfully

  # ================================================================
  # SERVICE 3: Feature Extraction Service (Python)
  # ================================================================
  feature-extraction:
    build:
      context: ../../services/feature-extraction
      dockerfile: Dockerfile
    image: mantis/feature-extraction:1.0.0
    container_name: mantis-feature-extraction
    hostname: feature-extraction
    restart: unless-stopped
    ports:
      - "8003:8003"
    environment:
      KAFKA_BOOTSTRAP_SERVERS: mantis-kafka:9092
      POSTGRES_HOST: mantis-postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: mantis
      POSTGRES_USER: mantis
      POSTGRES_PASSWORD: mantis_password
    networks:
      - mantis-network
    depends_on:
      kafka-wait:
        condition: service_completed_successfully

  # ================================================================
  # SERVICE 4: Anomaly Detection Service (Python)
  # ================================================================
  anomaly-detection:
    build:
      context: ../../services/anomaly-detection
      dockerfile: Dockerfile
    image: mantis/anomaly-detection:1.0.0
    container_name: mantis-anomaly-detection
    hostname: anomaly-detection
    restart: unless-stopped
    ports:
      - "8004:8004"
    environment:
      KAFKA_BOOTSTRAP_SERVERS: mantis-kafka:9092
      POSTGRES_HOST: mantis-postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: mantis
      POSTGRES_USER: mantis
      POSTGRES_PASSWORD: mantis_password
    networks:
      - mantis-network
    depends_on:
      kafka-wait:
        condition: service_completed_successfully

  # ================================================================
  # SERVICE 5: RUL Prediction Service (Python)
  # ================================================================
  rul-prediction:
    build:
      context: ../../services/rul-prediction
      dockerfile: Dockerfile
    image: mantis/rul-prediction:1.0.0
    container_name: mantis-rul-prediction
    hostname: rul-prediction
    restart: unless-stopped
    ports:
      - "8005:8005"
    environment:
      KAFKA_BOOTSTRAP_SERVERS: mantis-kafka:9092
      POSTGRES_HOST: mantis-postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: mantis
      POSTGRES_USER: mantis
      POSTGRES_PASSWORD: mantis_password
      MLFLOW_TRACKING_URI: http://mantis-mlflow:5000
    networks:
      - mantis-network
    depends_on:
      kafka-wait:
        condition: service_completed_successfully

  # ================================================================
  # SERVICE 6: Maintenance Orchestrator (Java/Spring Boot)
  # ================================================================
  orchestrator:
    build:
      context: ../../services/orchestrator
      dockerfile: Dockerfile
    image: mantis/orchestrator:1.0.0
    container_name: mantis-orchestrator
    hostname: orchestrator
    restart: unless-stopped
    ports:
      - "8006:8082"
    environment:
      SERVER_PORT: 8082
      SPRING_KAFKA_BOOTSTRAP_SERVERS: mantis-kafka:9092
      SPRING_DATASOURCE_URL: jdbc:postgresql://mantis-postgres:5432/mantis
      SPRING_DATASOURCE_USERNAME: mantis
      SPRING_DATASOURCE_PASSWORD: mantis_password
    networks:
      - mantis-network
    depends_on:
      kafka-wait:
        condition: service_completed_successfully

  # ================================================================
  # SERVICE 7: Dashboard API (Java/Spring Boot)
  # ================================================================
  dashboard-api:
    build:
      context: ../../services/dashboard-api
      dockerfile: Dockerfile
    image: mantis/dashboard-api:1.0.0
    container_name: mantis-dashboard-api
    hostname: dashboard-api
    restart: unless-stopped
    ports:
      - "8007:8083"
    environment:
      SERVER_PORT: 8083
      SPRING_KAFKA_BOOTSTRAP_SERVERS: mantis-kafka:9092
    networks:
      - mantis-network
    depends_on:
      kafka-wait:
        condition: service_completed_successfully

  # ================================================================
  # Wait for Kafka to be ready (from infrastructure)
  # ================================================================
  kafka-wait:
    image: alpine:3.18
    container_name: mantis-kafka-wait
    command: [ "sh", "-c", "echo 'Waiting for Kafka...' && sleep 10 && echo 'Kafka should be ready'" ]
    networks:
      - mantis-network

  # ================================================================
  # SERVICE 8: Dashboard Frontend (Static)
  # ================================================================
  dashboard-frontend:
    build:
      context: ../../services/dashboard-frontend
      dockerfile: Dockerfile
    image: mantis/dashboard-frontend:1.0.0
    container_name: mantis-dashboard-frontend
    hostname: dashboard-frontend
    restart: unless-stopped
    ports:
      - "3001:80"
    networks:
      - mantis-network
    depends_on:
      - dashboard-api
